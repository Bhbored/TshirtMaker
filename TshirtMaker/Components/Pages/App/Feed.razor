@page "/feed"
@layout MainLayout
@inject TestDataService DataService
@inject NavigationManager Nav

<PageTitle>TshirtMaker - Community Feed</PageTitle>

<main class="feed-main">
    <div class="feed-container">
        <div class="feed-header">
            <div class="feed-header-content">
                <h2 class="feed-title">Community Feed</h2>
                <p class="feed-subtitle">Discover the latest AI-generated fashion trends.</p>
            </div>
            <div class="feed-filters">
                <button class="feed-filter-btn @(activeFilter == "trending" ? "active" : "")"
                    @onclick="SetTrendingFilter">
                    Trending
                </button>
                <button class="feed-filter-btn @(activeFilter == "new" ? "active" : "")" @onclick="SetNewFilter">
                    New
                </button>
                <button class="feed-filter-btn @(activeFilter == "featured" ? "active" : "")"
                    @onclick="SetFeaturedFilter">
                    Featured Artists
                </button>
            </div>
        </div>

        <div class="feed-grid">
            @foreach (var design in feedDesigns)
            {
                <div class="feed-card">
                    <div class="feed-card-image">
                        <div class="feed-card-image-bg" style="background-image: url('@design.FinalImageUrl')"></div>
                        <div class="feed-card-actions">
                            <button class="feed-action-btn" title="Bookmark">
                                <span class="material-symbols-outlined">bookmark</span>
                            </button>
                            <button class="feed-action-btn" title="Share">
                                <span class="material-symbols-outlined">share</span>
                            </button>
                        </div>
                        @if (design.Likes > 1000)
                        {
                            <div class="feed-badge">Best of Week</div>
                        }
                    </div>
                    <div class="feed-card-body">
                        <div class="feed-card-header">
                            <div class="feed-user-info">
                                <div class="feed-user-avatar" style="background-image: url('@design.UserAvatar')"></div>
                                <div>
                                    <p class="feed-username">@design.Username</p>
                                    <p class="feed-user-badge">@GetUserBadge(design)</p>
                                </div>
                            </div>
                            <button class="feed-remix-btn" @onclick="@(() => NavigateToRemix(design.Id))">
                                <span class="material-symbols-outlined">bolt</span>
                                Remix
                            </button>
                        </div>
                        <div class="feed-prompt-box">
                            <p class="feed-prompt-text">"@design.Prompt"</p>
                        </div>
                        <div class="feed-card-footer">
                            <div class="feed-stats">
                                <div class="feed-stat-item">
                                    <span class="material-symbols-outlined feed-stat-icon">favorite</span>
                                    <span class="feed-stat-value">@FormatNumber(design.Likes)</span>
                                </div>
                                <div class="feed-stat-item">
                                    <span class="material-symbols-outlined feed-stat-icon">cyclone</span>
                                    <span class="feed-stat-value">@FormatNumber(design.Likes / 3)</span>
                                </div>
                                <div class="feed-stat-item">
                                    <span class="material-symbols-outlined feed-stat-icon">chat</span>
                                    <span class="feed-stat-value">@FormatNumber(design.Likes / 20)</span>
                                </div>
                            </div>
                            <span class="feed-timestamp">@GetTimeAgo(design.CreatedAt)</span>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="feed-loader">
            <div class="feed-loader-dots">
                <div class="feed-loader-dot"></div>
                <div class="feed-loader-dot"></div>
                <div class="feed-loader-dot"></div>
            </div>
            <span class="feed-loader-text">Loading Inspiration</span>
        </div>
    </div>

    <div class="feed-fab">
        <button class="feed-fab-btn" @onclick="NavigateToCreate" title="Create New Design">
            <span class="material-symbols-outlined">add</span>
            <div class="feed-fab-tooltip">Create New Design</div>
        </button>
    </div>
</main>

@code {
    private List<Design> feedDesigns = new();
    private string activeFilter = "trending";

    protected override void OnInitialized()
    {
        try
        {
            LoadFeedData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in Feed.OnInitialized: {ex.Message}");
            feedDesigns = new List<Design>();
        }
    }

    private void LoadFeedData()
    {
        try
        {
            if (DataService == null)
            {
                feedDesigns = new List<Design>();
                return;
            }

            var allDesigns = DataService.GetAllDesigns() ?? new List<Design>();

            feedDesigns = activeFilter switch
            {
                "trending" => allDesigns.OrderByDescending(d => d.Likes).Take(12).ToList(),
                "new" => allDesigns.OrderByDescending(d => d.CreatedAt).Take(12).ToList(),
                "featured" => allDesigns.Where(d => d.Likes > 500).OrderByDescending(d => d.Likes).Take(12).ToList(),
                _ => allDesigns.OrderByDescending(d => d.Likes).Take(12).ToList()
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in Feed.LoadFeedData: {ex.Message}");
            feedDesigns = new List<Design>();
        }
    }

    private void SetFilter(string filter)
    {
        activeFilter = filter;
        LoadFeedData();
        StateHasChanged();
    }

    private void SetTrendingFilter()
    {
        SetFilter("trending");
    }

    private void SetNewFilter()
    {
        SetFilter("new");
    }

    private void SetFeaturedFilter()
    {
        SetFilter("featured");
    }

    private string GetUserBadge(Design design)
    {
        if (design.Likes > 2000)
            return "Verified Creator";
        if (design.Likes > 1000)
            return "Top Artist";
        if (design.Likes > 500)
            return "Featured Artist";
        return "New Creator";
    }

    private string FormatNumber(int number)
    {
        if (number >= 1000)
            return $"{number / 1000.0:F1}k";
        return number.ToString();
    }

    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;

        if (timeSpan.TotalDays >= 1)
            return $"{(int)timeSpan.TotalDays} day{((int)timeSpan.TotalDays > 1 ? "s" : "")} ago";
        if (timeSpan.TotalHours >= 1)
            return $"{(int)timeSpan.TotalHours} hour{((int)timeSpan.TotalHours > 1 ? "s" : "")} ago";
        if (timeSpan.TotalMinutes >= 1)
            return $"{(int)timeSpan.TotalMinutes} minute{((int)timeSpan.TotalMinutes > 1 ? "s" : "")} ago";

        return "Just now";
    }

    private void NavigateToCreate()
    {
        Nav.NavigateTo("/create");
    }

    private void NavigateToRemix(string designId)
    {
        Nav.NavigateTo($"/create?remix={designId}");
    }
}
