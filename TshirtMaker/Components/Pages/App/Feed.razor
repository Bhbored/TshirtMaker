@page "/feed"
@layout MainLayout
@inject TestDataService DataService
@rendermode InteractiveServer
@inject AuthService Auth
@inject ILogger<Feed> Logger
@inject NavigationManager Nav

<PageTitle>TshirtMaker - Community Feed</PageTitle>

<main class="feed-main">
    <div class="feed-container">
        <div class="feed-header">
            <div class="feed-header-content">
                <h2 class="feed-title">Community Feed</h2>
                <p class="feed-subtitle">Discover the latest AI-generated fashion trends.</p>
            </div>
            <div class="feed-filters">
                <button class="feed-filter-btn @(activeFilter == "trending" ? "active" : "")"
                    @onclick="SetTrendingFilter">
                    Trending
                </button>
                <button class="feed-filter-btn @(activeFilter == "new" ? "active" : "")" @onclick="SetNewFilter">
                    New
                </button>
                <button class="feed-filter-btn @(activeFilter == "featured" ? "active" : "")"
                    @onclick="SetFeaturedFilter">
                    My Posts
                </button>
            </div>
        </div>

        <div class="feed-grid">
            @foreach (var x in feedPost)
            {
                <div class="feed-card">
                    <div class="feed-card-image">
                        <div class="feed-card-image-bg" style="background-image: url('@x.Design!.FinalImageUrl')"></div>
                        <div class="feed-card-actions">
                            <button class="feed-action-btn" title="Bookmark">
                                <span class="material-symbols-outlined">bookmark</span>
                            </button>
                            <button class="feed-action-btn" title="Share">
                                <span class="material-symbols-outlined">share</span>
                            </button>
                        </div>

                    </div>
                    <div class="feed-card-body">
                        <div class="feed-card-header">
                            <div class="feed-user-info">
                                <div class="feed-user-avatar" style="background-image: url('@x.Poster!.AvatarUrl')"></div>
                                <div>
                                    <p class="feed-username">@x.Poster!.Username</p>
                                </div>
                            </div>
                            <button class="feed-remix-btn" @onclick="@(() => NavigateToRemix(x.PosterId))">
                                <span class="material-symbols-outlined">bolt</span>
                                Remix
                            </button>
                        </div>
                        <div class="feed-prompt-box">
                            <p class="feed-prompt-text">"@x.Description"</p>
                        </div>
                        <div class="feed-card-footer">
                            <div class="feed-stats">
                                <div class="feed-stat-item">
                                    <span class="material-symbols-outlined feed-stat-icon">favorite</span>
                                    <span class="feed-stat-value">@FormatNumber(x.LikesCount)</span>
                                </div>
                                <div class="feed-stat-item">
                                    <span class="material-symbols-outlined feed-stat-icon">cyclone</span>
                                    <span class="feed-stat-value">@FormatNumber(x.LikesCount / 3)</span>
                                </div>
                                <div class="feed-stat-item">
                                    <span class="material-symbols-outlined feed-stat-icon">chat</span>
                                    <span class="feed-stat-value">@FormatNumber(x.LikesCount / 20)</span>
                                </div>
                            </div>
                            <span class="feed-timestamp">@GetTimeAgo(x.CreatedAt)</span>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="feed-loader">
            <div class="feed-loader-dots">
                <div class="feed-loader-dot"></div>
                <div class="feed-loader-dot"></div>
                <div class="feed-loader-dot"></div>
            </div>
            <span class="feed-loader-text">Loading Inspiration</span>
        </div>
    </div>

    <div class="feed-fab">
        <button class="feed-fab-btn" @onclick="NavigateToCreate" title="Create New x">
            <span class="material-symbols-outlined">add</span>
            <div class="feed-fab-tooltip">Create New x</div>
        </button>
    </div>
</main>

@code {
    private List<Post> feedPost = new();
    private string activeFilter = "trending";
    private User currentUser = new();
    private List<Post> userPosts = [];

    protected override void OnInitialized()
    {
        try
        {
            currentUser = Auth.CurrentUser ?? new();
            userPosts = DataService.GetUserPosts(currentUser.Id) ?? [];
            LoadFeedData();
        }
        catch (Exception ex)
        {
            Logger.LogInformation($"Error in Feed.OnInitialized: {ex.Message}");
            feedPost = new List<Post>();
        }
    }

    private void LoadFeedData()
    {
        try
        {
            if (DataService == null)
            {
                feedPost = new List<Post>();
                return;
            }

            var allPosts = DataService.GetAllPosts() ?? new List<Post>();

            feedPost = activeFilter switch
            {
                "trending" => allPosts.OrderByDescending(d => d.LikesCount).Take(12).ToList(),
                "new" => allPosts.OrderByDescending(d => d.CreatedAt).Take(12).ToList(),
                "featured" => userPosts,
                _ => allPosts.OrderByDescending(d => d.LikesCount).Take(12).ToList()
            };
        }
        catch (Exception ex)
        {
            Logger.LogInformation($"Error in Feed.LoadFeedData: {ex.Message}");
            feedPost = [];
        }
    }

    private void SetFilter(string filter)
    {
        activeFilter = filter;
        LoadFeedData();
        StateHasChanged();
    }

    private void SetTrendingFilter()
    {
        SetFilter("trending");
        StateHasChanged();
    }

    private void SetNewFilter()
    {
        SetFilter("new");
        StateHasChanged();

    }

    private void SetFeaturedFilter()
    {
        SetFilter("featured");
        StateHasChanged();

    }



    private string FormatNumber(int number)
    {
        if (number >= 1000)
            return $"{number / 1000.0:F1}k";
        return number.ToString();
    }

    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;

        if (timeSpan.TotalDays >= 1)
            return $"{(int)timeSpan.TotalDays} day{((int)timeSpan.TotalDays > 1 ? "s" : "")} ago";
        if (timeSpan.TotalHours >= 1)
            return $"{(int)timeSpan.TotalHours} hour{((int)timeSpan.TotalHours > 1 ? "s" : "")} ago";
        if (timeSpan.TotalMinutes >= 1)
            return $"{(int)timeSpan.TotalMinutes} minute{((int)timeSpan.TotalMinutes > 1 ? "s" : "")} ago";

        return "Just now";
    }

    private void NavigateToCreate()
    {
        Nav.NavigateTo("/create");
    }

    private void NavigateToRemix(Guid Id)
    {
        Nav.NavigateTo($"/create?remix={Id}");
    }
}
